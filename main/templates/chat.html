<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Chokdee Chatbot</title>
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
</head>
<body>
    <div id="chat-widget">
        <div id="chat-panel" style="display:none;">
            <div id="chat-header">
                 <span style="font-size:1.5rem;font-weight:bold;">Chokdee Thai Massage</span>
                 <span style="flex:1"></span>
                 <button onclick="closeChat()" style="background:none;border:none;font-size:1.3rem;color:#fff;cursor:pointer;">√ó</button>
            </div>
            <div id="chat-box"></div>
            <div id="chat-input-row">
                <input type="text" id="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeydown="if(event.key==='Enter'){sendMessage()}" autocomplete="off" />
                <button id="chat-send-btn" onclick="sendMessage()">‡∏™‡πà‡∏á</button>
            </div>
        </div>
        <div id="chat-bubble" onclick="openChat()" title="‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÅ‡∏ä‡∏ï‡∏ö‡∏≠‡∏ó">
            üí¨
        </div>
    </div>

    <script>
    const chatPanel = document.getElementById('chat-panel');
    const chatBubble = document.getElementById('chat-bubble');
    function openChat() {
        chatPanel.style.display = 'flex';
        chatBubble.style.display = 'none';
        setTimeout(() => document.getElementById('chat-input').focus(), 200);
    }
    function closeChat() {
        chatPanel.style.display = 'none';
        chatBubble.style.display = 'flex';
    }
    // ‡πÅ‡∏õ‡∏•‡∏á markdown/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô HTML ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
    function formatBotReply(text) {
        // ‡πÅ‡∏õ‡∏•‡∏á **bold** ‡πÄ‡∏õ‡πá‡∏ô <b>
        text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        // ‡πÅ‡∏õ‡∏•‡∏á * bullet ‡πÄ‡∏õ‡πá‡∏ô <li>
        text = text.replace(/\n\* /g, '<br>‚Ä¢ ');
        // ‡πÅ‡∏õ‡∏•‡∏á \n ‡πÄ‡∏õ‡πá‡∏ô <br>
        text = text.replace(/\n/g, '<br>');
        return text;
    }
    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message) return;
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML += `<div class=\"message user\"><b>‡∏Ñ‡∏∏‡∏ì:</b> ${message}</div>`;
        input.value = '';
        chatBox.scrollTop = chatBox.scrollHeight;
        try {
            const res = await fetch("/chat/", {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}"},
                body: new URLSearchParams({ message })
            });
            const data = await res.json();
            if (data.reply) {
                chatBox.innerHTML += `<div class=\"message bot\"><b>Chokdee:</b> ${formatBotReply(data.reply)}</div>`;
            } else {
                chatBox.innerHTML += `<div class=\"message bot\" style=\"color:red;\">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.error}</div>`;
            }
        } catch (e) {
            chatBox.innerHTML += `<div class=\"message bot\" style=\"color:red;\">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</div>`;
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    </script>
</body>
</html>
