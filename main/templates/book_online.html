{% load static %}
<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>จองคิวออนไลน์</title>

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <style>
      body { font-family: 'Kanit',sans-serif; background:#f8fff9; margin:0; }
      .container { max-width:1100px; margin:26px auto; padding:0 18px; }
      .grid { display:flex; gap:18px; }
      .sidebar { width:260px; }
      .employee-card { background:#fff; border-radius:10px; padding:12px; display:flex; gap:10px; align-items:center; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.05);} 
      .employee-card img{width:60px;height:60px;border-radius:8px;object-fit:cover}
      .employee-card.active { outline:3px solid #22c55e; }
      .main { flex:1; }
      .card { background:#fff;border-radius:10px;padding:14px; box-shadow:0 4px 10px rgba(0,0,0,.05) }
      .slot { display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee }
      .book-btn { background:#22c55e;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer }
      .book-btn[disabled]{opacity:0.6;cursor:not-allowed}
      .no-data{color:#666}
    </style>
  </head>

  <body>
    <div class="container">
      <h1>จองคิวออนไลน์</h1>
      <div class="grid">
        <aside class="sidebar">
          <div style="margin-bottom:10px">เลือกพนักงาน</div>
          <div id="employees">
            {% for e in employees %}
              <div class="employee-card" data-id="{{ e.id }}">
                {% if e.photo_url %}
                  <img src="{{ e.photo_url }}">
                {% endif %}
                <div>
                  <div style="font-weight:700">{{ e.display_name }}</div>
                  <div style="color:#666;font-size:13px">{{ e.role_title }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        </aside>

        <main class="main">
          <div class="card">
            <div id="calendar"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3 id="slotTitle">เลือกวันที่เพื่อดูเวลาที่ว่าง</h3>
            <div id="slotList"></div>
          </div>
        </main>
      </div>
    </div>

    <script>
      let selectedEmp = null;
      const employees = document.querySelectorAll('.employee-card');
      const slotList = document.getElementById('slotList');
      const slotTitle = document.getElementById('slotTitle');

      function setActiveCard(el){
        document.querySelectorAll('.employee-card').forEach(c=>c.classList.remove('active'));
        el.classList.add('active');
      }

      employees.forEach(el=>{
        el.addEventListener('click', ()=>{
          const id = el.dataset.id;
          selectedEmp = id;
          setActiveCard(el);
          loadCalendarFor(id);
        });
      });

      // FullCalendar init (will be re-created per employee)
      let calendar = null;
      function loadCalendarFor(empId){
        const calEl = document.getElementById('calendar');
        calEl.innerHTML = '';
        calendar = new FullCalendar.Calendar(calEl, {
          initialView: 'dayGridMonth',
          headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
          events: { url: `/employees/${empId}/events/`, failure: ()=>alert('ไม่สามารถโหลดปฏิทินได้') },
          dateClick: info => fetch(`/employees/${empId}/slots/${info.dateStr}/`).then(r=>r.json()).then(data=>renderSlots(data)).catch(()=>alert('โหลดเวลาผิดพลาด'))
        });
        calendar.render();
      }

      function renderSlots(data){
        slotTitle.textContent = `ตารางวันที่ ${data.date} ของ ${data.employee}`;
        slotList.innerHTML = '';
        if(!data.slots || data.slots.length===0){
          slotList.innerHTML = `<p class="no-data">ไม่มีข้อมูลเวลา</p>`;
          return;
        }
        data.slots.forEach(s=>{
          const d = document.createElement('div');
          d.className = 'slot';
          d.innerHTML = `<div>${s.time} (${s.duration} นาที)</div><div>${s.is_booked?'<span style="color:#a33">ไม่ว่าง</span>':`<button class="book-btn" onclick="bookSlot(${s.id})">จอง</button>`}</div>`;
          slotList.appendChild(d);
        });
      }

      function bookSlot(id){
        fetch(`/book/${id}/`, { method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')} })
        .then(r=>r.json()).then(j=>{ alert(j.message || 'จองเรียบร้อย'); if(calendar) calendar.refetchEvents(); loadCalendarFor(selectedEmp); })
        .catch(()=>alert('ไม่สามารถจองได้'));
      }

      function getCookie(name){
        let cookieValue = null;
        if (document.cookie && document.cookie !== ''){
          const cookies = document.cookie.split(';');
          for (let i=0;i<cookies.length;i++){
            const c = cookies[i].trim();
            if (c.substring(0,name.length+1) === (name + '=')) { cookieValue = decodeURIComponent(c.substring(name.length+1)); break; }
          }
        }
        return cookieValue;
      }

      // Auto-select first employee
      const first = document.querySelector('.employee-card');
      if(first) { first.click(); }
    </script>
  </body>
</html>